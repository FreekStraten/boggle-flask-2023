{% extends "layouts/base.html" %}
{% block content %}

<div id="game-root" class="container push-down"
     style="--board-size: {{ board_size }}; --cell: 72px; --gap: .75rem;">
  <div class="row justify-content-center g-4 align-items-stretch">

    <!-- LINKS: BORD -->
    <div class="col-12 col-lg-6 d-flex">
      <div class="card shadow-sm w-100 d-flex flex-column">
        <div class="card-header text-center py-2">
          <strong>Current Word: </strong><span id="current-word">{{ current_word }}</span>
        </div>

        <div class="card-body">
          <form action="/boggle/{{ game.id }}" method="post" class="m-0">
            {% if previous_letters %}
              <input type="hidden" name="previous_letters" value="{{ previous_letters }}">
            {% endif %}

            <div class="grid-container mx-auto">
              {% for _, die in dice %}
                {% set i = loop.index0 %}
                {% set last = selected_positions[-1] if selected_positions else None %}
                <button
                  type="submit"
                  name="position"
                  value="{{ i }}"
                  class="grid-item btn btn-secondary border rounded-3
                         {% if i == last %} current {% elif i in selected_positions %} path {% endif %}"
                  style="font-size: {{ font_size }}rem;">
                  {{ die }}
                </button>
              {% endfor %}
            </div>
          </form>
        </div>

        <div class="card-footer bg-transparent py-2 d-flex gap-2">
          <form action="/boggle/{{ game.id }}/reset" method="post" class="m-0">
            <button type="submit" class="btn btn-outline-secondary">Reset</button>
          </form>
          <div class="ms-auto"></div>
          <form action="/boggle/{{ game.id }}/submit" method="post" class="m-0">
            <input type="hidden" name="word" value="{{ current_word }}">
            <button type="submit" class="btn btn-primary">Submit word</button>
          </form>
        </div>
      </div>
    </div>

    <!-- RECHTS: TIMER/TAAL + GUESSED -->
    <div class="col-12 col-lg-4 d-flex">
      <div class="card shadow-sm w-100 d-flex flex-column">
        <div class="card-header py-2">
          <div class="d-flex align-items-center gap-2 justify-content-between">
            <span class="fw-semibold">Guessed words</span>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-dark">
                <i class="bi bi-clock-fill me-1"></i>
                <span id="remaining-time">{{ formatted_time }}</span>
              </span>
              <span class="badge bg-light text-dark border">
                <img class="me-1" src="https://flagcdn.com/{{ 'gb' if lang=='en' else 'nl' }}.svg"
                     width="20" height="14" alt="{{ 'English' if lang=='en' else 'Nederlands' }}">
                {{ 'English' if lang=='en' else 'Nederlands' }}
              </span>
            </div>
          </div>
        </div>

        <div class="card-body p-0">
          <ul class="list-group list-group-flush live-list">
            {% if guessed_words and guessed_words|length %}
              {% for guess in guessed_words %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ guess.word }}</span>
                  {% if guess.score is defined and guess.score is not none and guess.score > -1 %}
                    <span class="text-success d-inline-flex align-items-center">
                      {{ guess.score }} <i class="bi bi-check2 ms-2"></i>
                    </span>
                  {% else %}
                    <span class="text-danger d-inline-flex align-items-center">
                      {{ guess.score }} <i class="bi bi-x ms-2"></i>
                    </span>
                  {% endif %}
                </li>
              {% endfor %}
            {% else %}
              <li class="list-group-item text-muted">No words yetâ€¦</li>
            {% endif %}
          </ul>
        </div>

        <div class="card-footer bg-transparent mt-auto">
          <form id="end-game-form" action="/boggle/{{ game.id }}/end" method="post" class="m-0">
            <button type="submit" class="btn btn-danger w-100">End game</button>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  .grid-container{
    display:grid;
    grid-template-columns: repeat(var(--board-size), var(--cell));
    grid-auto-rows: var(--cell);
    gap: var(--gap);
    justify-content:center;
  }
  .grid-item{
    width: var(--cell);
    height: var(--cell);
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
  }
  .grid-item.path{
    background-color:#d1e7dd !important; color:#0f5132 !important; border-color:#badbcc !important;
  }
  .grid-item.current{
    background-color:#198754 !important; color:#fff !important; border:2px solid #fff !important;
    box-shadow:0 0 0 4px rgba(25,135,84,.35);
  }
  @media (max-width: 576px){
    #game-root{ --cell: 56px; --gap: .5rem; }
  }

  :root { --push: clamp(64px, 12vh, 160px); }
  .push-down { padding-top: var(--push); padding-bottom: 2rem; }

  @media (max-width: 576px){
    :root { --push: clamp(16px, 6vh, 56px); }
  }

  /* Scrollbare live-woordenlijst zoals end-page */
  .live-list{ max-height: 360px; overflow-y: auto; }
</style>

<script>
(() => {
  const endForm = document.getElementById('end-game-form');
  const remainingEl = document.getElementById('remaining-time');

  // Zorg voor een getal
  let t = parseInt('{{ amount_time|default(0)|int }}', 10);
  if (Number.isNaN(t) || t < 0) t = 0;

  let ended = false;
  const fmt = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;

  const disableUI = () => {
    document.querySelectorAll('button, input, a.btn').forEach(el => el.setAttribute('disabled', 'disabled'));
  };

  const endGame = () => {
    if (ended) return;
    ended = true;
    disableUI();
    if (remainingEl) remainingEl.textContent = "Time's up!";
    if (endForm) endForm.submit(); else window.location.href = '/boggle/{{ game.id }}/end';
  };

  const tick = () => {
    if (remainingEl) remainingEl.textContent = fmt(Math.max(0, t));
    if (t <= 0) return;
    t -= 1;
  };

  // Start
  tick();
  const intervalId = setInterval(() => {
    tick();
    if (t <= 0) { clearInterval(intervalId); endGame(); }
  }, 1000);

  // Hard fallback
  setTimeout(endGame, Math.max(0, t) * 1000 + 200);
})();
</script>

{% endblock %}
